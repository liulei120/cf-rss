# RSS Feed Reader KV 缓存系统设置指南

本文档提供了如何设置和使用新的KV缓存系统的详细说明，以优化RSS Feed阅读器的性能。

## 概述

我们将应用程序的缓存系统从Cloudflare的临时Cache API更改为更持久、更可靠的KV存储解决方案。这种改变可以：

- 提供更持久的数据存储
- 减少缓存验证和读取的复杂性
- 支持异步缓存更新
- 自动处理缓存过期

## 设置步骤

### 1. 创建KV命名空间

在Cloudflare Dashboard中：

1. 登录您的Cloudflare账户
2. 进入Workers & Pages
3. 点击"KV"选项卡
4. 点击"创建命名空间"
5. 命名为"RSS_KV"（或您喜欢的名称）
6. 复制生成的ID（稍后需要）

### 2. 检查wrangler.toml配置

wrangler.toml文件已配置为使用环境变量引用KV命名空间ID：

```toml
[[kv_namespaces]]
binding = "RSS_KV"
id = "$KV_NAMESPACE_ID"
```

### 3. 设置环境变量

在Cloudflare Dashboard的Pages项目"设置">"环境变量"中，添加或更新以下环境变量：

- `KV_NAMESPACE_ID`: 您在步骤1中创建的KV命名空间的ID
- `CACHE_MAX_AGE`: 缓存的最大年龄（秒），建议值为7200（2小时）
- `UPDATE_KEY`: 用于手动更新缓存的密钥

**注意**: 使用环境变量存储KV命名空间ID是一种安全实践，特别是当代码放在公开的GitHub仓库中时。

## 使用方法

### 自动缓存

系统现在会自动：
- 第一次访问时，创建缓存
- 读取有效缓存时，直接返回数据
- 缓存接近过期时（达到最大年龄的80%），触发异步更新
- 缓存过期后，获取新数据并更新缓存

### 手动刷新缓存

如果您需要手动更新缓存，可以访问：

```
https://您的域名/api/update-cache?key=您设置的UPDATE_KEY
```

## 排查问题

### 缓存未更新

1. 检查KV命名空间环境变量是否正确设置
2. 验证其他环境变量是否正确配置
3. 查看Cloudflare Worker日志寻找错误

### 环境变量问题

如果您遇到与环境变量相关的问题：
1. 确保在Cloudflare Dashboard中正确设置了所有环境变量
2. 确保选择了正确的环境（生产/预览）
3. 部署后可能需要几分钟环境变量才能生效

### 性能问题

如果仍然遇到性能问题：

1. 增加`CACHE_MAX_AGE`值延长缓存时间
2. 检查RSS源的可靠性和响应时间

## 技术细节

新的缓存系统实现了以下改进：

1. **异步更新机制**: 当缓存即将过期时，在后台更新缓存，用户不必等待
2. **简化的缓存验证**: 减少了复杂的缓存验证和内容检查
3. **元数据存储**: 缓存包含了时间戳等有用元数据，便于管理
4. **自动过期**: 利用KV的内置过期机制自动删除旧缓存

## 从旧缓存系统迁移

迁移是自动的。一旦部署了新代码并设置好环境变量，第一次API请求将创建新的KV缓存，不需要手动迁移步骤。 